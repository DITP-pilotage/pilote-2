openapi: 3.1.0
x-stoplight:
  id: x0ygm9j5iky4x
info:
  title: pilote-api
  version: 0.1.0
  summary: API Pilote.
  description: |-
    Cette API permet d'interagir avec Pilote. Via cette API, il est possible de récupérer les données de Pilote et d'importer de nouvelles données.

    # Autorisations

    Les autorisations sont identiques à celles de votre compte Pilote existant. Vous ne pourrez accéder et modifier que des données auxquelles vous avez déjà accès via Pilote.

    # Détails techniques
    ## Authentification

    Pour utiliser l'API, vous devrez **récupérer un token d'API**. Celui-ci sera à demander par email à l'adresse [support.ditp@modernisation.gouv.fr](mailto:support.ditp@modernisation.gouv.fr?subject=[api.token]%20&cc=colin.dugeai@modernisation.gouv.fr&body=%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%20tag:api.token) avec en début d'objet *[api.token]*.

    Ce token devra être inséré en *header* pour chaque requête envoyée vers l'API. `Authorization: Bearer <token>`.

    Par exemple, pour obtenir les données  d'un indicateur:

    ```
    curl -X 'GET' \
      'https://pilote.modernisation.gouv.fr/api/indicateur/IND-123/donnees' \
      -H 'accept: application/json' \
      -H 'Authorization: Bearer <ACCESS_TOKEN>'
    ```

    ## Comprendre le fichier d’import

    Pour mettre à jour vos données, vous devrez remplir un modèle d’import avec les champs suivants.

    *   `identifiant_indic` • Identifiant unique de l’indicateur. Exemple : IND-001, IND-002, IND-003. (voir identifiant précisé plus haut sur la page)
    *   `zone_id` • Identifiant du territoire pour lequel la donnée est renseignée. Il provient des référentiels INSEE et est interopérable. Exemple : D34, D20... (voir le référentiel ci-dessous)
    *   `zone_nom` • Champ facultatif précisant les territoires auxquels correspondent les zone-id. Vous n’êtes pas obligé(e) d’inclure cette colonne.
    *   `date_valeur` • Date à laquelle se réfère la valeur numérique. La date doit être renseignée selon le modèle suivant année-mois-jour. Exemple : 2023-02-26, 2023-01-17...
    *   `type_valeur` • Type de données insérées : vi pour valeur initiale, va pour valeur actuelle, vc pour valeur cible
    *   `valeur` • Valeur de l’indicateur. La valeur doit être numérique. Ne pas saisir de texte (par exemple “NC” ou “non renseigné”)

    Les formats acceptés sont csv et xlsx

    | identifiant_indic | zone_id | zone_nom (facultatif) | date_valeur | type_valeur | valeur |
    |-------------------|---------|-----------------------|-------------|-------------|--------|
    | IND-009           | D12     | Aveyron               | 2023-03-31  | va          | 5      |
    | IND-009           | D13     | Bouches-du-Rhône      | 2023-01-17  | va          | 12     |
    | IND-009           | D14     | Calvados              | 2023-02-26  | va          | 20     |

    Ce fichier d'import sera envoyé à l'endpoint `POST: /indicateur/<ID-indicateur>/donnees` (voir documentation plus bas).

    ## Référentiels

    Consultez les référentiels pour retrouver les codes de tous les territoires (départements, régions, et national). Vous pourrez copier dans ce référentiel les valeurs à indiquer pour les champs zone-id et zone dans le modèle d’import fourni.

    Il s'agit des codes INSEE des départements et régions précédés respectivement par `D` ou `R`. Pour désigner le niveau national, on utilise `FRANCE`.

    [Télécharger le référentiel des territoires XLSX – 12 ko](https://github.com/DITP-pilotage/pilote-2/raw/dev/public/referentiel/referentiel_territoires.xlsx)

    ## Comment bien remplir le fichier d’import ?

    *   Si vous choisissez le format CSV pour importer les données, veuillez utiliser le point-virgule (;) pour délimiter les colonnes et les guillemets (") pour délimiter les chaines de caractères
    *   Si vous saisissez un taux, la valeur saisie doit se trouver entre 1 et 100. Par exemple, pour 78%, renseignez la valeur 78.
    *   L'encodage du fichier doit être en UTF-8
    *   Si vous importez une cellule vide, la valeur précédente sera écrasée (si existante)
    *   Toutes les zones du template d'import ne sont pas nécessaires. Certaines lignes du fichier d'import peuvent être supprimées. Il n’est ainsi pas nécessaire d’importer la totalité des départements pour chaque mise à jour.
    *   Il n'est pas possible d'importer plusieurs valeurs pour la même zone, date, identifiant d'indicateur et type de valeur. Cela générerait une erreur.

    **Si vous rencontrez des difficultés, merci de nous contacter à l’adresse suivante** (en mentionnant *[api]* dans l'objet de votre mail): [support.ditp@modernisation.gouv.fr](mailto:support.ditp@modernisation.gouv.fr?subject=[api]%20&cc=colin.dugeai@modernisation.gouv.fr&body=%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%20tag:api)
  contact: {}
servers:
  - url: 'http://localhost:3000'
    description: Local
  - url: 'http://172.17.0.1:3000'
    description: Docker local
paths:
  '/ppg/{ppg_id}':
    parameters:
      - schema:
          type: string
          example: PPG-003
          pattern: '^PPG-[0-9][0-9][0-9]$'
          minLength: 7
          maxLength: 7
        name: ppg_id
        in: path
        required: true
        description: Identifiant de la PPG
    get:
      summary: Informations PPG
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PPG'
              examples:
                PPG d'exemple:
                  value:
                    id: PPG-014
                    nom: Première PPG
                    description: Description de la PPG
                    axe_id:
                      id: EMPLOI
      operationId: get-ppg-id
      description: Obtenir les informations sur une PPG
      parameters: []
      tags:
        - PPG
  '/chantier/{chantier_id}':
    parameters:
      - schema:
          type: string
          example: CH-005
          pattern: '^CH-[0-9][0-9][0-9]$'
          minLength: 6
          maxLength: 6
        name: chantier_id
        in: path
        required: true
        description: Identifiant du chantier
    get:
      summary: Informations chantier
      tags:
        - Chantier
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Chantier'
              examples:
                Example 1:
                  value:
                    id: CH-001
                    description: Description textuelle du premier chantier
                    nom: Premier chantier prioritaire
                    directeur_projet: Jean Dupont
                    ppg_id: PPG-123
                    porteurs: MEFSIN | MSAPH
                    perimetre_id: PER-019
                    territorialise: true
                    engagement: EMPLOI
                    etat: PUBLIE
      operationId: get-chantier-id
      description: Obtenir les informations sur un chantier
      parameters: []
    put:
      summary: Modifier un chantier
      operationId: post-chantier-id
      responses:
        '200':
          description: OK
      description: Modifier les informations sur un chantier
      x-internal: true
      tags:
        - Chantier
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Chantier'
  '/indicateur/{indicateur_id}':
    parameters:
      - schema:
          type: string
        name: indicateur_id
        in: path
        required: true
    get:
      summary: Informations indicateur
      tags:
        - Indicateur
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Indicateur'
              examples:
                Example 1:
                  value:
                    id: CH-001
                    description: Description textuelle du premier chantier
                    nom: Premier chantier prioritaire
                    directeur_projet: Jean Dupont
                    ppg_id: PPG-123
                    porteurs: MEFSIN | MSAPH
                    perimetre_id: PER-019
                    territorialise: true
                    engagement: EMPLOI
                    etat: PUBLIE
      operationId: get-indicateur-id
      description: Obtenir les informations sur un indicateur
      parameters: []
    put:
      summary: Modifier un indicateur
      operationId: post-indicateur-id
      responses:
        '200':
          description: OK
      description: Modifier les informations sur un indicateur
      x-internal: true
      tags:
        - Indicateur
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Indicateur'
    post:
      summary: Import données indicateur
      operationId: post-indicateur-indicateur_id
      responses:
        '200':
          description: OK
      description: Ajout de données d'un indicateur
      tags:
        - Indicateur
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                x-stoplight:
                  id: mruq4uoieht0v
                type: object
                properties:
                  zone_id:
                    type: string
                    x-stoplight:
                      id: blgo0owpsk8tc
                    description: Zone concernée par la valeur
                    example: D22
                  date_valeur:
                    type: string
                    x-stoplight:
                      id: n46miuipk8svp
                    description: Date d'effet de la valeur
                    example: 18/03/2024
                  type_valeur:
                    type: string
                    x-stoplight:
                      id: 17gpabcm2adch
                    example: vi
                    description: Type de la valeur
                  valeur:
                    type: string
                    x-stoplight:
                      id: soplj7kcf5lqe
                    description: 'Valeur de l''indicateur à cette date, zone'
                    example: '24.7'
                required:
                  - zone_id
                  - date_valeur
                  - type_valeur
                  - valeur
        description: Ensemble des données indicateurs à ajouter.
  '/indicateur/{indicateur_id}/donnees':
    parameters:
      - schema:
          type: string
        name: indicateur_id
        in: path
        required: true
    get:
      summary: Informations indicateur
      tags:
        - Indicateur
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DonneesIndicateur'
        '403':
          description: Vous n'avez pas accès à cet indicateur.
          content: {}
          headers: {}
      operationId: get-donnees-indicateur
      description: Obtenir les données de l'indicateur au format JSON.
      parameters: []
    post:
      summary: Import données indicateur
      operationId: post-donnees-indicateur
      responses:
        '200':
          description: L'import de données a fonctionné.
        '400':
          description: Le fichier n'est pas valide.
      description: Ajout de données d'un indicateur. Le format d'entrée est un fichier CSV formaté comme sur Pilote (voir instructions ci-dessus).
      tags:
        - Indicateur
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  x-stoplight:
                    id: cwvqhg1h40as2
                  description: Fichier CSV au format Pilote.
              required:
                - file
          application/json:
            schema:
              type: object
              properties: {}
        description: Fichier CSV de données à importer.
components:
  schemas:
    Chantier:
      title: Chantier
      x-stoplight:
        id: p5jtbeh5h8v1h
      type: object
      description: Description complète d'un chantier prioritaire.
      examples:
        - id: CH-001
          description: Description textuelle du premier chantier
          nom: Premier chantier prioritaire
          directeur_projet: Jean Dupont
          ppg_id: PPG-123
          porteurs: MEFSIN | MSAPH
          perimetre_id: PER-019
          territorialise: true
          engagement: EMPLOI
          etat: PUBLIE
      properties:
        id:
          type: string
          description: Identifiant du chantier
          pattern: '^CH-[0-9][0-9][0-9]$'
        description:
          type: string
          x-stoplight:
            id: zdi3an2y785p5
          description: Description du chantier
        nom:
          type: string
          x-stoplight:
            id: cyz7ea8cxcy1a
          description: Nom du chantier
        directeur_projet:
          type: string
          x-stoplight:
            id: r49po0dyvgn0n
          description: Nom du directeur de projet
        ppg_id:
          x-stoplight:
            id: ztoyprmidlw0v
          description: Identifiant de la PPG
          type: string
          pattern: '^PPG-[0-9][0-9][0-9]$'
          example: PPG-001
        porteurs:
          type: string
          x-stoplight:
            id: zyifvj48w8g4s
          description: Liste des porteurs du chantier (séparés par " | ").
          example: MEFSIN | MSAPH
        perimetre_id:
          type: string
          x-stoplight:
            id: q2f4thq23mxe4
          example: PER-019
          pattern: '^PER-[0-9][0-9][0-9]$'
          description: Identifiant du périmètre du chantier
        territorialise:
          type: boolean
          x-stoplight:
            id: osknraxgj0nzn
          description: Etat de territorialisation du chantier (Oui/non)
        engagement:
          type: string
          x-stoplight:
            id: tx1xg9r1jx1e3
          enum:
            - EMPLOI
            - PROGRES
            - TE
            - ENGAG
          example: EMPLOI
          description: Engagement auquel appartient le chantier
        etat:
          type: string
          x-stoplight:
            id: r5xhoq4owsiaw
          enum:
            - PUBLIE
            - BROUILLON
            - NON_PUBLIE
          example: PUBLIE
          description: Etat de publication du chantier
      required:
        - id
        - description
        - nom
        - ppg_id
        - perimetre_id
        - territorialise
        - etat
      x-tags:
        - Chantier
    PPG:
      title: PPG
      x-stoplight:
        id: y5p9457oy9ahb
      type: object
      examples:
        - id: PPG-014
          nom: Première PPG
          description: Description de la PPG
          axe_id:
            id: EMPLOI
      properties:
        id:
          type: string
          description: Identifiant de la PPG
          pattern: '^PPG-[0-9][0-9][0-9]$'
          example: PPG-014
        nom:
          type: string
          x-stoplight:
            id: 38z6p01nyhsyz
          example: Mieux vivre de son travail
        description:
          type: string
          x-stoplight:
            id: q86g1ouyl59k9
        axe_id:
          $ref: '#/components/schemas/Axe'
          x-stoplight:
            id: 4tdqltir7n7y4
      required:
        - id
        - nom
      description: Politique Prioritaire du Gouvernement
    Axe:
      title: Axe
      x-stoplight:
        id: pkmunivqndbww
      type: object
      properties:
        id:
          type: string
          example: EMPLOI
    Indicateur:
      title: Indicateur
      x-stoplight:
        id: dso2wkhwfj33t
      type: object
      properties:
        id:
          type: string
    DonneesIndicateur:
      title: DonneesIndicateur
      x-stoplight:
        id: d87zbgfotvdkf
      type: array
      description: Données concernant un indicateur et le chantier qui le porte.
      items:
        x-stoplight:
          id: u8wjidllz7cfa
        type: object
        properties:
          maille:
            type: string
            x-stoplight:
              id: iqt9tzbfs95rk
            description: Maille de la donnée
          region:
            type: string
            x-stoplight:
              id: gzzi5slzq2qrt
            description: Région de la donnée
          departement:
            type: string
            x-stoplight:
              id: non5fnkl3v7vj
            description: Département de la donnée
          ministere:
            type: string
            x-stoplight:
              id: sf94ez5jun1xw
            description: Ministère associé à l'indicateur
          chantier:
            type: string
            x-stoplight:
              id: 20zsgz0aw414v
            description: Chantier qui contient cet indicateur
          chantier_id:
            type: string
            x-stoplight:
              id: cu6m4l1nwmz8q
            description: ID du chantier
            pattern: ^CH-\d\d\d\d?
          chantier_barometre:
            type: string
            x-stoplight:
              id: 0kw83nhfjwhzg
            description: Le chantier est-il présent dans le baromètre
            enum:
              - 'Oui, Non'
          tag_chantier:
            type: number
            x-stoplight:
              id: 5i0ahdyoja8tt
            description: Taux d'avancement global du chantier
            minimum: 0
            maximum: 100
          meteo:
            type: string
            x-stoplight:
              id: eelrj0un9w049
            description: Météo du chantier sur cette zone
          indicateur:
            type: string
            x-stoplight:
              id: 3fn9s2q19i2ev
            description: Indicateur concerné
          vi:
            type: number
            x-stoplight:
              id: owyhtsljd8de6
            description: Valeur initiale
          date_vi:
            type: string
            x-stoplight:
              id: sxyeuknp16gsq
            description: Date de valeur initiale
            example: 01-01-2022
            format: date-fr
            pattern: \d\d-\d\d-20\d\d
          va:
            type: number
            x-stoplight:
              id: zvbcj4ylk2wme
            description: Valeur actuelle
          date_va:
            type: string
            x-stoplight:
              id: az8yprulj0u71
            description: Date de valeur actuelle
            format: date-fr
            example: 01-01-2022
            pattern: \d\d-\d\d-20\d\d
          vca:
            type: number
            x-stoplight:
              id: b9509kqxe72s1
            description: Valeur cible annuelle
          date_vca:
            type: string
            x-stoplight:
              id: 3m565zgaew07y
            description: Date de la valeur cible annuelle
            format: date-fr
            example: 01-01-2022
            pattern: \d\d-\d\d-20\d\d
          taa:
            type: number
            x-stoplight:
              id: kzdbkdjsjsuzp
            description: Taux d'avancement annuel de l'indicateur
            minimum: 0
            maximum: 100
          vcg:
            type: number
            x-stoplight:
              id: m0m0bl1zhjhug
            description: Valeur cible globale
          date_vcg:
            type: string
            x-stoplight:
              id: gowiw29j38gme
            description: Date de la valeur cible globale
            format: date-fr
            pattern: \d\d-\d\d-20\d\d
            example: 01-01-2022
          tag:
            type: number
            x-stoplight:
              id: vh23hnu85wwpu
            description: Taux d'avancement global de l'indicateur
            minimum: 0
            maximum: 100
  securitySchemes:
    abc-123:
      name: X-API-KEY
      type: apiKey
      in: header
      description: Cette clé d'API vous permet de vous authentifier et d'aacéder uniquement aux resources autorisées.
  parameters:
    chantier_id:
      name: chantier_id
      in: query
      schema:
        type: string
        pattern: bla
      description: Identifiant de chantier
      required: true
tags:
  - name: Chantier
    description: Opérations sur les chantiers prioritaires
  - name: Indicateur
    description: Opérations sur les indicateurs des chantiers prioritaires
  - name: PPG
    description: Opérations sur les PPG (Politiques Prioritaires du Gouvernement)
  - name: WIP
    description: Développements en cours
x-internal: false
